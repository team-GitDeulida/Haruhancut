# This workflow will build a Swift project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-swift

name: ğŸš€ Fastlane TestFlight Deployment

on:
  push:
    branches:
      - develop  # âœ… develop ë¸Œëœì¹˜ì— pushë  ë•Œ ì‹¤í–‰

jobs:
  build-and-deploy:
    runs-on: macos-14  # âœ… ìµœì‹  macOS í™˜ê²½ ì‚¬ìš©
    env:
      # Fastlaneì— ì‚¬ìš©í•  í™˜ê²½ ë³€ìˆ˜ë“¤ì„ ì „ì—­ìœ¼ë¡œ ì£¼ì…í•©ë‹ˆë‹¤.
      APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
      APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
      APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      # ğŸ”‘ SSH í‚¤ ì„¤ì • (GitHub Private Repository ì ‘ê·¼)
      - name: ğŸ”‘ Setup SSH Key for GitHub
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.GIT_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      # ğŸ”§ Set up Ruby and Bundler
      - name: ğŸ”§ Set up Ruby and Bundler
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.1
          bundler-cache: true

      # ğŸ” Configure Keychain
      - name: ğŸ” Configure Keychain
        run: |
          security create-keychain -p "" test.keychain
          security list-keychains -s test.keychain
          security default-keychain -s test.keychain
          security unlock-keychain -p "" test.keychain
          security set-keychain-settings -t 3600 -l ~/Library/Keychains/test.keychain

      # ğŸ”‘ Import Certificate and Set Key Partition List
      - name: ğŸ”‘ Import Certificate and Set Key Partition List
        run: |
          echo "$CERTIFICATE_P12" | base64 --decode > certificate.p12
          security import certificate.p12 -k test.keychain -P "$CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "" test.keychain
        env:
          CERTIFICATE_P12: ${{ secrets.CERTIFICATE_P12 }}
          CERTIFICATE_PASSWORD: ${{ secrets.CERTIFICATE_PASSWORD }}

      # ğŸ“„ Install Provisioning Profile
      - name: ğŸ“„ Install Provisioning Profile
        run: |
          echo "$PROVISIONING_PROFILE" | base64 --decode > provisioning.mobileprovision
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp provisioning.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
        env:
          PROVISIONING_PROFILE: ${{ secrets.PROVISIONING_PROFILE }}

      # ğŸ›  Setup Xcode
      - name: ğŸ›  Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "16.1.0"

      # ğŸ”“ Run Fastlane match (SSH ë°©ì‹)
      - name: ğŸ”“ Run Fastlane match
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
        run: |
          git clone git@github.com:team-GitDeulida/Haruhancut-Private.git certs_repo
          bundle exec fastlane match appstore --readonly

      # ğŸ”‘ Create API Key File
      - name: ğŸ”‘ Create API Key File
        run: |
          mkdir -p ~/.private_keys
          echo "$APP_STORE_CONNECT_PRIVATE_KEY" > ~/.private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY }}.p8
          chmod 600 ~/.private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY }}.p8
        env:
          APP_STORE_CONNECT_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}

      # ğŸ Debug Fastlane API Key Environment Variables
      - name: Debug Fastlane API Key Environment Variables
        run: |
          if [ -z "$APP_STORE_CONNECT_API_KEY_ID" ]; then echo "APP_STORE_CONNECT_API_KEY_ID is not set"; else echo "APP_STORE_CONNECT_API_KEY_ID is set"; fi
          if [ -z "$APP_STORE_CONNECT_API_KEY_ISSUER_ID" ]; then echo "APP_STORE_CONNECT_API_KEY_ISSUER_ID is not set"; else echo "APP_STORE_CONNECT_API_KEY_ISSUER_ID is set"; fi
          if [ -z "$APP_STORE_CONNECT_API_KEY_CONTENT" ]; then echo "APP_STORE_CONNECT_API_KEY_CONTENT is not set"; else echo "APP_STORE_CONNECT_API_KEY_CONTENT is set"; fi

      # ğŸš€ Fastlane Archive & Export
      - name: ğŸš€ Fastlane Archive & Export
        run: bundle exec fastlane beta
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          # ì´ë¯¸ ì „ì—­ envì—ì„œ ì„¤ì •í•œ Fastlane API í‚¤ ë³€ìˆ˜ë“¤ì€ ì—¬ê¸°ì„œë„ ì‚¬ìš©ë©ë‹ˆë‹¤.
          FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT: 60  # â±ï¸ íƒ€ì„ì•„ì›ƒ 1ë¶„ìœ¼ë¡œ ì„¤ì •
